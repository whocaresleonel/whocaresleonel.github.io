  <script>
    const ADMIN_EMAIL = '2010984@apps.nsd.org';

    // --- TOOLBAR FUNCTION ---
    function openAIApp() {
        window.open('https://cosinehq.web.app', '_blank');
    }

    // --- SITE ACCESS & TOKEN LOGIC ---
    function showAuthForms(formId) {
        ['token-login-step', 'password-login-step', 'register-step', 'show-token-step'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = (id === formId) ? 'block' : 'none';
            }
        });
    }
    
    function generateToken() {
        const numbers = '0123456789';
        const letters = 'abcdefghijklmnopqrstuvwxyz';
        let token = '';
        token += numbers.charAt(Math.floor(Math.random() * numbers.length));
        token += numbers.charAt(Math.floor(Math.random() * numbers.length));
        token += letters.charAt(Math.floor(Math.random() * letters.length));
        return token;
    }

    function register() {
        const realName = document.getElementById("registerRealName").value.trim();
        const studentEmail = document.getElementById("registerStudentEmail").value.trim();
        const password = document.getElementById("registerPassword").value;
        const statusEl = document.getElementById("registerStatus");
        const emailRegex = /^\d{7}@apps\.nsd\.org$/;

        if (!realName || !studentEmail || !password) { statusEl.textContent = "All fields are required."; return; }
        if (!emailRegex.test(studentEmail)) { statusEl.textContent = "Please use a valid student email (e.g., 1234567@apps.nsd.org)."; return; }
        
        const username = studentEmail.split('@')[0];
        if (localStorage.getItem('user_' + username)) { statusEl.textContent = "This student email is already registered."; return; }
        
        const token = generateToken();
        const user = { username, realName, studentEmail, password, token };
        localStorage.setItem('user_' + username, JSON.stringify(user));
        
        sessionStorage.setItem('currentUser', username);
        document.getElementById('token-display').textContent = token;
        showAuthForms('show-token-step');
    }
    
    function loginWithPassword() {
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;
        const statusEl = document.getElementById("authStatus");
        const userString = localStorage.getItem('user_' + username);
        const user = userString ? JSON.parse(userString) : null;

        if (user && user.password === password) {
            sessionStorage.setItem('currentUser', username);
            document.getElementById('token-display').textContent = user.token;
            showAuthForms('show-token-step');
        } else {
            statusEl.textContent = "Invalid username or password.";
        }
    }
    
    function loginWithToken() {
        const tokenInput = document.getElementById("token-input").value.trim().toLowerCase();
        const statusEl = document.getElementById("token-status");

        if (!tokenInput) { statusEl.textContent = "Please enter a token."; return; }

        let userFound = null;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('user_')) {
                const user = JSON.parse(localStorage.getItem(key));
                if (user.token && user.token.toLowerCase() === tokenInput) {
                    userFound = user;
                    break;
                }
            }
        }

        if (userFound) {
            localStorage.setItem('persistedUser', userFound.username);
            grantAccess();
        } else {
            statusEl.textContent = "Invalid token. Please try again.";
        }
    }

    function continueAndGrantAccess() {
        const currentUser = sessionStorage.getItem('currentUser');
        if (currentUser) {
            localStorage.setItem('persistedUser', currentUser);
        }
        grantAccess();
    }

    function grantAccess() {
        document.getElementById('verification-overlay').style.opacity = '0';
        setTimeout(() => { document.getElementById('verification-overlay').style.display = 'none'; }, 500);
        const mainContent = document.getElementById('main-content');
        mainContent.style.visibility = 'visible';
        mainContent.style.opacity = '1';
        initializeSite();
    }

    let currentPanelId = null;
    function togglePanel(panelId) {if (currentPanelId === panelId) { document.getElementById(panelId).classList.remove('visible'); currentPanelId = null; return; } if (currentPanelId) { document.getElementById(currentPanelId).classList.remove('visible'); } document.getElementById(panelId).classList.add('visible'); currentPanelId = panelId; if (panelId === 'accountPanel') checkLoginStatus(); if (panelId === 'chatPanel') loadChatMessages(); if (panelId === 'usersPanel') displayUserList();}
    function searchGames() {const searchTerm = document.getElementById("searchInput").value.toLowerCase(); document.querySelectorAll(".game-grid a").forEach(link => { link.style.display = link.textContent.toLowerCase().includes(searchTerm) ? "block" : "none"; });}
    function applyTheme(theme) { document.body.className = ''; if (theme !== 'default') { document.body.classList.add(theme); }}
    function applyCloak(cloak) { document.title = cloak ? "Gmail - Inbox" : "Nebula"; document.querySelector("link[rel='icon']").href = cloak ? "https://raw.githubusercontent.com/samw53/nebula/main/Gmail-logo.png" : "https://raw.githubusercontent.com/samw53/nebula/main/Nebula.png"; }
    function logout() { localStorage.removeItem('persistedUser'); sessionStorage.removeItem('currentUser'); location.reload(); }
    
    function updateAccount() {
        const currentUser = sessionStorage.getItem('currentUser'); if (!currentUser) return;
        const newUsername = document.getElementById("newUsername").value.trim();
        const statusEl = document.getElementById("updateStatus");
        let user = JSON.parse(localStorage.getItem('user_' + currentUser));

        if (newUsername && newUsername !== currentUser) {
            if (localStorage.getItem('user_' + newUsername)) { statusEl.textContent = "New username is taken."; return; }
            user.username = newUsername; 
            localStorage.removeItem('user_' + currentUser);
            localStorage.setItem('user_' + newUsername, JSON.stringify(user));
            sessionStorage.setItem('currentUser', newUsername);
            localStorage.setItem('persistedUser', newUsername);
            statusEl.textContent = "Username updated successfully!";
        } else {
            statusEl.textContent = "No changes made.";
        }
        checkLoginStatus();
        setTimeout(() => statusEl.textContent = "", 3000);
    }
    
    function checkLoginStatus() {
        const currentUser = sessionStorage.getItem('currentUser');
        const userDisplay = document.getElementById('userDisplay');
        const loggedInView = document.getElementById('loggedInView');
        document.querySelectorAll('.admin-only-button').forEach(btn => btn.style.display = 'none');
        document.getElementById('users-toolbar-btn').style.display = 'none';

        if (currentUser) {
            loggedInView.style.display = 'block';
            const user = JSON.parse(localStorage.getItem('user_' + currentUser));
            document.getElementById('newUsername').value = user.username;
            document.getElementById('displayRealName').textContent = user.realName;
            document.getElementById('displayStudentEmail').textContent = user.studentEmail;
            userDisplay.innerHTML = `<span>Logged in: <strong>${currentUser}</strong></span><button id="logoutButton" onclick="logout()">Logout</button>`;
            
            if (user.studentEmail === ADMIN_EMAIL) {
                document.querySelectorAll('.admin-only-button').forEach(btn => btn.style.display = 'block');
                document.getElementById('users-toolbar-btn').style.display = 'block';
            }
        } else {
            loggedInView.style.display = 'none';
            userDisplay.innerHTML = '';
        }
    }
    
    function revealPassword(element, password) {
        const childSpan = element.querySelector('.password-field-text');
        if (childSpan && !element.classList.contains('revealed')) {
            childSpan.textContent = password;
            element.classList.add('revealed');
        }
    }

    function displayUserList() {
        const container = document.getElementById("user-list-container");
        if (!container) return; // Exit if the container isn't found
        container.innerHTML = "";

        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) return; // Only display if a user is logged in (to check for admin)

        const currentUserData = JSON.parse(localStorage.getItem('user_' + currentUser));
        const isAdmin = currentUserData && currentUserData.studentEmail === ADMIN_EMAIL;
        
        if (!isAdmin) return;
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('user_')) {
                const user = JSON.parse(localStorage.getItem(key));
                let passwordDisplay = '';
                if (user.password) {
                    // Escape single quotes in the password to prevent breaking the onclick attribute
                    const escapedPassword = user.password.replace(/'/g, "\\'");
                    passwordDisplay = `<p><strong>Password:</strong> <span class="password-field-container" onclick="revealPassword(this, '${escapedPassword}')"><span class="password-field-text">(Click to Reveal)</span></span></p>`;
                }

                const userDiv = document.createElement('div');
                userDiv.className = 'user-list-item';
                let removeButtonHTML = '';
                if (user.studentEmail !== ADMIN_EMAIL) {
                    removeButtonHTML = `<button class="admin-only-button" style="display: block;" onclick="removeUser('${user.username}')">Remove User</button>`;
                }

                userDiv.innerHTML = `<h3>${user.realName}</h3><p><strong>Username:</strong> ${user.username}</p><p><strong>Email:</strong> ${user.studentEmail}</p>${passwordDisplay}${removeButtonHTML}`;
                container.appendChild(userDiv);
            }
        }
    }
    
    function removeUser(usernameToRemove) {
        if (confirm(`Are you sure you want to permanently remove the user "${usernameToRemove}"?`)) {
            localStorage.removeItem('user_' + usernameToRemove);
            displayUserList();
        }
    }

    function clearChats() {
        if (confirm('Are you sure you want to permanently delete ALL chat messages? This cannot be undone.')) {
            localStorage.removeItem('chatMessages');
            loadChatMessages();
        }
    }

    function ensureAdminExists() {
        const adminUsername = ADMIN_EMAIL.split('@')[0];
        if (!localStorage.getItem('user_' + adminUsername)) {
            const adminUser = { username: adminUsername, realName: 'Sam Wouters', studentEmail: ADMIN_EMAIL, password: 'pink9goat9desk', token: '54k' };
            localStorage.setItem('user_' + adminUsername, JSON.stringify(adminUser));
        } else {
            let adminUser = JSON.parse(localStorage.getItem('user_' + adminUsername));
            if (!adminUser.password || adminUser.token !== '54k') {
                 adminUser.password = 'pink9goat9desk';
                 adminUser.token = '54k';
                 localStorage.setItem('user_' + adminUsername, JSON.stringify(adminUser));
            }
        }
    }
    
    function sendMessage() {
        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) { alert("Please log in to send a message."); return; }
        const input = document.getElementById("chatInput");
        const messageText = input.value.trim();
        
        if (messageText !== "") {
            const messages = JSON.parse(localStorage.getItem("chatMessages") || "[]");
            messages.push({ user: currentUser, text: messageText, timestamp: new Date().toISOString() });
            localStorage.setItem("chatMessages", JSON.stringify(messages));
            input.value = "";
            loadChatMessages();
        }
    }

    function loadChatMessages() {
        const container = document.getElementById("chatMessages");
        const messages = JSON.parse(localStorage.getItem("chatMessages") || "[]");
        container.innerHTML = "";
        messages.forEach(msg => {
            const user = JSON.parse(localStorage.getItem('user_' + msg.user));
            const displayName = user ? user.realName : msg.user;
            const p = document.createElement("p");
            p.innerHTML = `<b>${displayName}:</b> ${msg.text}`;
            container.appendChild(p);
        });
        container.scrollTop = container.scrollHeight;
    }

    function makeToolbarDraggable(toolbar) { 
        let offsetX, offsetY, isDragging = false; 
        toolbar.addEventListener('mousedown', (e) => { 
            if (e.target.closest('button')) return;
            isDragging = true; 
            offsetX = e.clientX - toolbar.offsetLeft; 
            offsetY = e.clientY - toolbar.offsetTop; 
            toolbar.style.transform = 'none'; 
            document.addEventListener('mousemove', onMouseMove); 
            document.addEventListener('mouseup', onMouseUp); 
        }); 
        function onMouseMove(e) { 
            if (!isDragging) return; 
            toolbar.style.left = `${e.clientX - offsetX}px`; 
            toolbar.style.top = `${e.clientY - offsetY}px`; 
        } 
        function onMouseUp() { 
            isDragging = false; 
            document.removeEventListener('mousemove', onMouseMove); 
            document.removeEventListener('mouseup', onMouseUp); 
            localStorage.setItem('toolbarPosition', JSON.stringify({ x: toolbar.style.left, y: toolbar.style.top })); 
        } 
    }

    function initializeSite() {
        const savedTheme = localStorage.getItem("theme") || "default";
        applyTheme(savedTheme);
        document.getElementById("themeSelector").value = savedTheme;
        const savedCloak = localStorage.getItem("cloak") === 'true';
        applyCloak(savedCloak);
        document.getElementById("cloakCheckbox").checked = savedCloak;
        
        const toolbar = document.querySelector('.side-toolbar');
        const savedPosition = JSON.parse(localStorage.getItem('toolbarPosition'));
        if (savedPosition) {
            toolbar.style.transform = 'none';
            toolbar.style.left = savedPosition.x;
            toolbar.style.top = savedPosition.y;
        } else {
            toolbar.style.left = '15px';
            toolbar.style.top = '50%';
            toolbar.style.transform = 'translateY(-50%)';
        }
        makeToolbarDraggable(toolbar);
        
        checkLoginStatus();
        displayUserList(); // Also display the list when the site initializes after login
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        try {
            ensureAdminExists();
            
            const persistedUser = localStorage.getItem('persistedUser');
            if (persistedUser && localStorage.getItem('user_' + persistedUser)) {
                 sessionStorage.setItem('currentUser', persistedUser);
                 grantAccess();
                 return;
            }
            
            let usersExist = false;
            for (let i = 0; i < localStorage.length; i++) {
                if (localStorage.key(i).startsWith('user_')) {
                    usersExist = true;
                    break;
                }
            }
            
            if (usersExist) {
                showAuthForms('token-login-step'); 
            } else {
                showAuthForms('register-step');
            }
        } catch (error) {
            console.error("Critical error on page load:", error);
            document.body.innerHTML = 'A critical error occurred. Please check the console (F12) for details.';
        }
    });
  </script>
</body>
</html>
